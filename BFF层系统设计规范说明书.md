以下是将文档内容转换为 Markdown 格式的结果：

---

# BFF层系统设计规范说明书

## 文档属性

| 属性     | 内容                                          |
| -------- | --------------------------------------------- |
| 用户名称 | -                                             |
| 文档标题 | BFF层系统设计规范说明书                       |
| 文档编号 | -                                             |
| 版本日期 | -                                             |
| 发布版本 | -                                             |
| 适用范围 | 微服务架构下使用springboot框架建设bff层的系统 |
| 作者     | 杨明洁                                        |

## 修订内容

| 版本 | 修正章节 | 日期   | 修正人 | 变更记录     |
| ---- | -------- | ------ | ------ | ------------ |
| 1.0  | 全部     | 2021.6 | 杨明洁 | 初稿         |
| 1.0  | 3.1      | 2021.6 | 杨明洁 | 修改入参设计 |

## 目录

1. [前言](#前言)
   1.1 [背景](#背景)
   1.2 [概念和术语定义](#概念和术语定义)
   1.3 [参考资料](#参考资料)
2. [方案概述](#方案概述)
   2.1 [方案的目标](#方案的目标)
   2.2 [设计约束和遵循规范](#设计约束和遵循规范)
      2.2.1 [设计约束](#设计约束)
      2.2.2 [遵循规范](#遵循规范)
   2.3 [关键内容概览](#关键内容概览)
      2.3.1 [BFF系统定位及能力清单](#bff系统定位及能力清单)
      2.3.2 [适应微前端架构的认证传递和权限控制](#适应微前端架构的认证传递和权限控制)
3. [关键方案说明](#关键方案说明)
   3.1 [统一登录ASSO及会话认证方案](#统一登录asso及会话认证方案)
      3.1.1 [登录流程模型](#登录流程模型)
      3.1.2 [会话认证模型](#会话认证模型)
      3.1.3 [功能时序说明](#功能时序说明)
      3.1.4 [非功能性要求](#非功能性要求)
      3.1.5 [实施细节](#实施细节)
   3.2 [BFF层服务设计](#bff层服务设计)
      3.2.1 [接口基础设计](#接口基础设计)
      3.2.2 [安全性设计](#安全性设计)
      3.2.3 [扩展兼容设计](#扩展兼容设计)
   3.3 [跨应用请求安全方案](#跨应用请求安全方案)
      3.3.1 [建立系统内角色权限对应关系](#建立系统内角色权限对应关系)
      3.3.2 [业务系统与中台系统权限创建要求](#业务系统与中台系统权限创建要求)
   3.4 [BFF系统工程结构](#bff系统工程结构)
   3.5 [部署方案](#部署方案)
   3.6 [CICD流水线方案](#cicd流水线方案)

---

## 1. 前言

### 1.1 背景

为解决微服务架构下前端与服务端系统功能的耦合问题，引入BFF层进行系统间解耦和适配。

### 1.2 概念和术语定义

- **BFF**：即Backend For Frontend（服务于前端的后端），作为前端管理系统和个贷微服务系统连接层。

### 1.3 参考资料

| 序号 | 文档名称                            | 最后修订时间 | 版本号 | 来源 | 作者 |
| ---- | ----------------------------------- | ------------ | ------ | ---- | ---- |
| 1    | 个贷前端装配-BFF层设计方案说明书    | 2021-04      | V0.4   |      |      |
| 2    | 基于web的asso适配器项目说明书       | 2021-06      | V0.2   |      |      |
| 3    | Web组件的checkSession功能项目说明书 | 2021-06      | V0.6   |      |      |

---

## 2. 方案概述

### 2.1 方案的目标

1. 明确BFF层在个贷技术架构中的作用及分层位置。
2. 明确系统内功能清单，及每个功能的实现方案。
3. 形成系统内结构设计、服务设计及开发的规范，调用和信息交互规范。

### 2.2 设计约束和遵循规范

#### 2.2.1 设计约束

- 每个前端都配自己的一套BFF系统。
- **BFF接口设计约束**：
  1. 遵循"非必要，不新增"原则。
  2. BFF层服务仅做防重发、服务转发/协议转换、实体映射和字段脱敏遮蔽、安全加固处理。
- **与BFF对接的服务设计**：
  1. 服务均是无状态服务，服务设计保证幂等性。
  2. 设计时服务应考虑多渠道适配。

#### 2.2.2 遵循规范

- **工程目录设计**：目录结构设计上应具有明确区分业务功能。
- **接口入参设计规范**：接口入参应贯标（参照rpc贯标），渠道标识；命名统一采取驼峰命名法。
- **接口返回数据设计规范**：必须包含返回结果码、回显提示信息、错误信息、数据实体信息。
- **接口路径设计规范**：对外提供的路径包含版本号，名称应清晰明确地表达业务意义。
- **数据安全性设计规范**：响应数据脱敏处理，如敏感信息或用户隐私信息需做脱敏处理。
- **服务安全性设计规范**：提高服务安全性，具备基本攻击防范能力（如：sql注入，XSS，CSRF）。
- **接口兼容性设计**：接口版本升级务必包含接口全部存量功能。

### 2.3 关键内容概览

#### 2.3.1 BFF系统定位及能力清单

BFF在部署架构中位于生产区，逻辑上处于WEB和API层之间，提供http接口，调用后台接口协议包括crpc，http及tcp等多种协议。功能包含：

- 登录拦截（ASSO、NSSO）
- 会话保持
- 服务限流/防重发
- 服务权限控制
- 主子应用会话认证传递
- 服务转发/协议转换/实体转换
- 信息/日志脱敏
- 注入攻击防护

#### 2.3.2 适应微前端架构的认证传递和权限控制

结合技术平台微前端架构下会话认证传递方案，以及行内统一登录、参数配置平台，统一鉴权中心建设情况，主子应用对接需满足以下条件：

1. 接入统一登录ASSO
2. 主子应用各自建立权限控制体系

---

## 3. 关键方案说明

### 3.1 统一登录ASSO及会话认证方案

#### 3.1.1 登录流程模型

![image-20250206193516011](C:\Users\77032\AppData\Roaming\Typora\typora-user-images\image-20250206193516011.png)

请求个贷后台页面具体url，访问个贷后端页面。BFF系统内判断当前用户登录状态，如用户未登录，则引导登录。登录后跳转指定页面。Web端判断当前页面是否需要调产品中心页面，如需要，web端将请求转发至产品中心应用。

#### 3.1.2 会话认证模型

![image-20250206193508907](C:\Users\77032\AppData\Roaming\Typora\typora-user-images\image-20250206193508907.png)

根据技术平台当前最新方案，应用间session共享的功能将放在乐高框架和UFP框架中完成，应用内session共享由各系统配置redis集群方式完成。应用间Session共享思路如下：

1. 个贷管理端（主应用）发起产品中心应用请求，到子应用的路由使用appProxy标记做拦截
2. 请求转发至个贷BFF应用，框架层面调用产品中心checkSession方法
3. 产品中心应用完成session创建后，将新建的sessionId回传，个贷bff将sid关联关系维护到session中
4. 页面请求产品中心服务，拦截到个贷BFF应用中，框架层面读取关联产品中心的sid，再将请求携带sid转发至产品中心nginx，完成服务调用，返回json数据。

#### 3.1.3 功能时序说明

以个贷产品驱动场景为例：

![image-20250206193454184](C:\Users\77032\AppData\Roaming\Typora\typora-user-images\image-20250206193454184.png)

#### 3.1.4 非功能性要求

使用乐高和UFP框架进行开发，并通过行内ASSO作登录验证，CBSP作配置管理。

#### 3.1.5 实施细节

以下改造中涉及的技术平台组件具体用法可参照wiki，springboot组件中的使用方法。

---

### 3.2 BFF层服务设计

#### 3.2.1 接口基础设计

BFF层对外提供的http接口，路径定义上需表意明确（注明功能、版本号），参数字段采用驼峰命名，响应数据需包含响应结果码、回显提示信息、错误信息、数据实体（参照crpc报文要求）。

#### 3.2.2 安全性设计

- **数据脱敏**：响应数据中,用户的隐私字段要脱敏处理。
- **服务安全性校验**：黑白名单控制功能和安全加固设计。
- **功能访问权限控制**：在CBSP权限管理中增加url的访问权限配置。
- **防重复请求机制**：系统中参考原3.0中防重发请求的设计思路。

#### 3.2.3 扩展兼容设计

请求入参统一设计为JSONObject，在系统内增加服务、实体类别的映射模块，转发服务前将参数转成目标Service定义的强对象，再进行转发。

---

### 3.3 跨应用请求安全方案

#### 3.3.1 建立系统内角色权限对应关系

系统内建立角色和访问权限体系，以免客户经理从业务系统访问中台时使用所有权限以外的功能。

#### 3.3.2 业务系统与中台系统权限创建要求

业务系统和中台均在统一鉴权中心配置各自系统的角色和功能权限、数据权限。

---

### 3.4 BFF系统工程结构

BFF系统搭建依赖springboot框架，工程结构可遵守《SD05-05-05-3级-2020（1）基于乐高开发平台（统一开发平台4.0）应用开发规范（1.0版，2020年）》中BFF项目结构。

![image-20250206193656785](C:\Users\77032\AppData\Roaming\Typora\typora-user-images\image-20250206193656785.png)

---

### 3.5 部署方案

按行内安全最新要求，系统均部署在生产区，可通过办公区访问转发至生产区。

---

### 3.6 CICD流水线方案

流水线搭建同springboot后端系统。参照《新一代个贷系统建设DevOps实施规范说明书》。

---

**注**：文档中的图片部分未直接转换为Markdown格式，建议在Markdown文档中插入图片链接或使用图床服务。